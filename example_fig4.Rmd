---
title: "Untitled"
author: "EW"
date: "11/5/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sdmTMB)
library(dplyr)
library(ggplot2)
library(viridis)
```

```{r}
# Species of interest
species = read.csv("survey_data/species_list.csv", fileEncoding="UTF-8-BOM")
names(species) = tolower(names(species))
species = dplyr::rename(species,
                        common_name = common.name,
                        scientific_name = scientific.name)

grid = readRDS("data/wc_grid.rds")
grid = dplyr::rename(grid, lon = X, lat = Y)
grid = dplyr::mutate(grid,
  lon = lon*10, # scale to units of km
  lat = lat*10,
  depth_scaled = as.numeric(scale(-depth)),
  depth_scaled2 = depth_scaled^2) %>%
  dplyr::select(-log_depth_scaled,
    -log_depth_scaled2)

grid$cell = seq(1,nrow(grid))
pred_grid = expand.grid(cell = grid$cell, year = 2003:2018)
pred_grid = dplyr::left_join(pred_grid, grid)
pred_grid$year = as.factor(pred_grid$year)
pred_grid$time = as.numeric(pred_grid$year) - floor(mean(unique(as.numeric(pred_grid$year))))

null_predictions = readRDS("output/null_predictions_summary.rds")
ll_predictions = readRDS("output/ll_predictions_summary.rds")

```


This is just using darkblotched rockfish, and years 2003 - 2018 for comparison
```{r}
indx = which(species$species=="Darkblotched rockfish")
# get predictions for each model
  pred_grid$pred_ll = ll_predictions[[indx]][,1]
  pred_grid$pred_null = null_predictions[[indx]][,1]
  # subset years to 2003 and 2018
  pred_grid = dplyr::filter(pred_grid, year %in%c(2003,2018))
```

First we can make a plot of the absolute difference

```{r}
  # make plots of difference
  g0 = pred_grid %>%
    ggplot(aes(lon,lat,fill=pred_ll - pred_null)) +
    geom_tile() +
    scale_fill_gradient2() +
    facet_grid(~year) +
    coord_fixed() +
    theme_bw()
print(g0)
```

```{r}
  # calculate de-meaned data frame, subtracting off spatial mean for each cell
  pred_grid <- dplyr::group_by(pred_grid, cell) %>%
    dplyr::mutate(ll_mean = mean(pred_ll),
                  null_mean = mean(pred_null)) %>%
    dplyr::ungroup()
  pred_grid$ll_dev <- pred_grid$pred_ll - pred_grid$ll_mean
  pred_grid$null_dev <- pred_grid$pred_null - pred_grid$null_mean
  pred_grid = dplyr::select(pred_grid, -ll_mean, -null_mean)


  pred_grid2 <- pred_grid
  pred_grid2$est = pred_grid2$null_dev
  pred_grid2$type = "Null"
  pred_grid$est = pred_grid$ll_dev
  pred_grid$type = "Non-stationary"
  pred_grid = rbind(pred_grid, pred_grid2)
  pred_grid$model = paste0(pred_grid$year, pred_grid$type)

# first version: this plots fields that are spatially de-meaned
  g2 =  ggplot(pred_grid, aes(lon,lat,fill=est)) +
    geom_tile() +
    scale_fill_gradient2() +
    facet_grid(year~type) +
    coord_fixed() +
    theme_bw()
print(g2)
```

